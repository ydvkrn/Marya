<script>
        console.log('üîê Secure Admin Panel - Loading...');
        
        // Admin configuration
        const ADMIN_KEY = 'MARYA2025ADMIN'; // Change this to your desired admin key
        let allFiles = [];
        let selectedFiles = new Set();
        let deleteQueue = [];
        let isLoggedIn = false;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });

        // Authentication functions
        function checkAuthStatus() {
            const savedAuth = localStorage.getItem('maryaAdminAuth');
            const savedTime = localStorage.getItem('maryaAdminTime');
            
            if (savedAuth === 'true' && savedTime) {
                const loginTime = parseInt(savedTime);
                const currentTime = Date.now();
                const timeDiff = currentTime - loginTime;
                
                // Session expires after 4 hours
                if (timeDiff < (4 * 60 * 60 * 1000)) {
                    showAdminDashboard();
                    return;
                }
            }
            
            showLoginScreen();
        }

        function validateLogin(event) {
            event.preventDefault();
            
            const keyInput = document.getElementById('adminKey');
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');
            
            const enteredKey = keyInput.value.trim();
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validating...';
            errorDiv.style.display = 'none';
            
            setTimeout(() => {
                if (enteredKey === ADMIN_KEY) {
                    // Successful login
                    localStorage.setItem('maryaAdminAuth', 'true');
                    localStorage.setItem('maryaAdminTime', Date.now().toString());
                    showAdminDashboard();
                    showToast('Admin access granted!', 'success');
                } else {
                    // Failed login
                    errorDiv.style.display = 'block';
                    keyInput.value = '';
                    keyInput.focus();
                    
                    // Log failed attempt
                    console.warn('‚ùå Invalid admin key attempt:', enteredKey);
                }
                
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-key"></i> Access Admin Panel';
            }, 1000);
            
            return false;
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminDashboard').classList.remove('show');
            isLoggedIn = false;
            
            // Focus on key input
            setTimeout(() => {
                document.getElementById('adminKey').focus();
            }, 100);
        }

        function showAdminDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminDashboard').classList.add('show');
            isLoggedIn = true;
            
            // Set login time display
            document.getElementById('loginTime').textContent = new Date().toLocaleTimeString();
            
            // Load files and setup dashboard
            loadFiles();
            setupSearchFilter();
        }

        function logout() {
            localStorage.removeItem('maryaAdminAuth');
            localStorage.removeItem('maryaAdminTime');
            showLoginScreen();
            showToast('Logged out successfully', 'success');
        }

        // FIXED: Load all files from KV with proper error handling
        async function loadFiles() {
            if (!isLoggedIn) return;
            
            console.log('üìÇ Loading files from KV namespaces...');
            
            try {
                showLoading(true);
                
                console.log('üåê Fetching /admin/list-files...');
                const response = await fetch('/admin/list-files', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${ADMIN_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('üì° Response status:', response.status);
                console.log('üì° Response headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Response not OK:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const responseText = await response.text();
                    console.error('‚ùå Invalid content type:', contentType);
                    console.error('‚ùå Response text:', responseText.substring(0, 500));
                    throw new Error(`Expected JSON, got: ${contentType}. Response: ${responseText.substring(0, 200)}...`);
                }

                const data = await response.json();
                console.log('üìä API Response:', data);
                
                if (data.success) {
                    allFiles = data.files || [];
                    updateStats(data.stats);
                    displayFiles(allFiles);
                    console.log(`‚úÖ Loaded ${allFiles.length} files`);
                } else {
                    throw new Error(data.error || 'Failed to load files');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to load files:', error);
                showToast(`Failed to load files: ${error.message}`, 'error');
                showEmptyState();
            } finally {
                showLoading(false);
            }
        }

        // Update statistics
        function updateStats(stats) {
            document.getElementById('totalFiles').textContent = stats.totalFiles || 0;
            document.getElementById('totalSize').textContent = formatBytes(stats.totalSize || 0);
            document.getElementById('activeFiles').textContent = stats.activeFiles || 0;
            document.getElementById('kvNamespaces').textContent = stats.kvNamespaces || 0;
        }

        // Display files in table
        function displayFiles(files) {
            const tbody = document.getElementById('filesTableBody');
            
            if (files.length === 0) {
                showEmptyState();
                return;
            }

            tbody.innerHTML = '';
            showFilesTable();

            files.forEach(file => {
                const row = createFileRow(file);
                tbody.appendChild(row);
            });
        }

        // Create file table row
        function createFileRow(file) {
            const row = document.createElement('tr');
            row.dataset.fileId = file.id;
            
            const fileIcon = getFileIcon(file.filename);
            const uploadDate = new Date(file.uploadedAt).toLocaleDateString();
            const status = getFileStatus(file);
            
            row.innerHTML = `
                <td>
                    <input type="checkbox" class="file-checkbox" value="${file.id}" onchange="toggleFileSelection('${file.id}')">
                </td>
                <td>
                    <div class="file-info">
                        <div class="file-icon ${fileIcon.type}">
                            <i class="${fileIcon.icon}"></i>
                        </div>
                        <div class="file-details">
                            <h4>${truncateText(file.filename, 40)}</h4>
                            <p>ID: ${file.id}</p>
                        </div>
                    </div>
                </td>
                <td class="file-size">${formatBytes(file.size)}</td>
                <td>${file.contentType || 'Unknown'}</td>
                <td>${uploadDate}</td>
                <td><span class="status-badge ${status.class}">${status.text}</span></td>
                <td>
                    <div class="file-actions">
                        <a href="/btfstorage/file/${file.id}${file.extension || ''}" target="_blank" class="btn btn-primary btn-sm">
                            <i class="fas fa-eye"></i> View
                        </a>
                        <a href="/btfstorage/file/${file.id}${file.extension || ''}?dl=1" class="btn btn-success btn-sm">
                            <i class="fas fa-download"></i> Download
                        </a>
                        <button onclick="deleteFile('${file.id}', '${file.filename}')" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </td>
            `;
            
            return row;
        }

        // Get file icon based on type
        function getFileIcon(filename) {
            const ext = filename.split('.').pop()?.toLowerCase() || '';
            
            if (['mp4', 'mkv', 'avi', 'mov', 'webm', 'flv', '3gp'].includes(ext)) {
                return { type: 'video', icon: 'fas fa-video' };
            } else if (['mp3', 'wav', 'flac', 'aac', 'm4a', 'ogg'].includes(ext)) {
                return { type: 'audio', icon: 'fas fa-music' };
            } else if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(ext)) {
                return { type: 'image', icon: 'fas fa-image' };
            } else if (['pdf', 'doc', 'docx', 'txt'].includes(ext)) {
                return { type: 'document', icon: 'fas fa-file-alt' };
            } else if (['zip', 'rar', '7z', 'tar'].includes(ext)) {
                return { type: 'archive', icon: 'fas fa-archive' };
            }
            
            return { type: 'other', icon: 'fas fa-file' };
        }

        // Get file status
        function getFileStatus(file) {
            if (file.neverExpires) {
                return { class: 'status-permanent', text: 'Permanent' };
            }
            
            return { class: 'status-active', text: 'Active' };
        }

        // Search and filter
        function setupSearchFilter() {
            const searchInput = document.getElementById('searchInput');
            
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase();
                
                if (query === '') {
                    displayFiles(allFiles);
                    return;
                }
                
                const filtered = allFiles.filter(file => 
                    file.filename.toLowerCase().includes(query) ||
                    file.id.toLowerCase().includes(query) ||
                    (file.contentType && file.contentType.toLowerCase().includes(query))
                );
                
                displayFiles(filtered);
            });
        }

        // File selection
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.file-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                toggleFileSelection(checkbox.value);
            });
        }

        function toggleFileSelection(fileId) {
            const checkbox = document.querySelector(`input[value="${fileId}"]`);
            
            if (checkbox.checked) {
                selectedFiles.add(fileId);
            } else {
                selectedFiles.delete(fileId);
            }
            
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            
            if (selectedFiles.size > 0) {
                deleteBtn.style.display = 'inline-flex';
                deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Delete ${selectedFiles.size} Selected`;
            } else {
                deleteBtn.style.display = 'none';
            }
        }

        // Refresh files list
        async function refreshFilesList() {
            selectedFiles.clear();
            document.getElementById('selectAll').checked = false;
            updateDeleteButton();
            await loadFiles();
            showToast('Files list refreshed', 'success');
        }

        // Delete functions
        function deleteFile(fileId, filename) {
            deleteQueue = [{ id: fileId, filename: filename }];
            showDeleteModal();
        }

        function deleteSelected() {
            if (selectedFiles.size === 0) return;
            
            deleteQueue = Array.from(selectedFiles).map(fileId => {
                const file = allFiles.find(f => f.id === fileId);
                return { id: fileId, filename: file ? file.filename : 'Unknown' };
            });
            
            showDeleteModal();
        }

        function showDeleteModal() {
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            deleteQueue = [];
        }

        async function confirmDelete() {
            if (deleteQueue.length === 0) return;
            
            try {
                closeDeleteModal();
                showToast('Deleting files...', 'success');
                
                console.log('üóëÔ∏è Deleting files:', deleteQueue.map(f => f.id));
                
                const response = await fetch('/admin/delete-files', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ADMIN_KEY}`
                    },
                    body: JSON.stringify({
                        fileIds: deleteQueue.map(f => f.id)
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                console.log('üóëÔ∏è Delete result:', result);
                
                if (result.success) {
                    showToast(`Successfully deleted ${result.deletedCount} files`, 'success');
                    await refreshFilesList();
                } else {
                    throw new Error(result.error || 'Delete failed');
                }
                
            } catch (error) {
                console.error('Delete error:', error);
                showToast(`Delete failed: ${error.message}`, 'error');
            }
        }

        // Utility functions
        function showLoading(show) {
            document.getElementById('loadingSection').style.display = show ? 'block' : 'none';
        }

        function showFilesTable() {
            document.getElementById('filesTableContainer').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
        }

        function showEmptyState() {
            document.getElementById('filesTableContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = type === 'success' ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';

            toast.innerHTML = `
                ${icon}
                <div>
                    <div style="font-weight: 600;">${type === 'success' ? 'Success' : 'Error'}</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">${message}</div>
                </div>
            `;

            toast.className = `toast ${type} show`;

            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        console.log('‚úÖ Secure Admin Panel - Ready!');
    </script>
