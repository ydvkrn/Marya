<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Marya Admin - Lite</title>
<style>
:root {
    --red: #dc2626;
    --white: #ffffff;
    --gray: #6b7280;
    --green: #059669;
    --blue: #3b82f6;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, var(--red), #b91c1c);
    min-height: 100vh;
    color: #1f2937;
    font-size: 14px;
}

.container { max-width: 100%; margin: 0 auto; padding: 1rem; }

/* Login */
.login-screen {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 1rem;
}

.login-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    padding: 2rem;
    width: 100%;
    max-width: 350px;
    text-align: center;
}

.login-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--red);
    margin-bottom: 1rem;
}

.login-input {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1rem;
    margin-bottom: 1rem;
    text-align: center;
    font-family: monospace;
}

.login-input:focus {
    outline: none;
    border-color: var(--red);
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
}

.login-btn {
    width: 100%;
    padding: 0.75rem;
    background: var(--red);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
}

.login-error {
    color: var(--red);
    font-size: 0.8rem;
    margin-top: 0.5rem;
    display: none;
}

/* Admin */
.admin-dashboard { display: none; }
.admin-dashboard.show { display: block; }

.header {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header h1 {
    font-size: 1.2rem;
    color: var(--red);
    font-weight: 700;
}

.logout-btn {
    padding: 0.5rem 1rem;
    background: var(--red);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
}

/* Stats */
.stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
}

.stat-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    border-left: 3px solid var(--red);
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--red);
}

.stat-label {
    font-size: 0.7rem;
    color: var(--gray);
    text-transform: uppercase;
}

/* Controls */
.controls {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.search-input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    margin-bottom: 0.5rem;
}

.btn {
    width: 100%;
    padding: 0.5rem;
    background: var(--red);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
}

.btn-sm {
    width: auto;
    padding: 0.25rem 0.5rem;
    font-size: 0.7rem;
    margin: 0.1rem;
}

.btn-blue { background: var(--blue); }
.btn-green { background: var(--green); }

/* Files */
.files-section {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 8px;
    overflow: hidden;
}

.section-header {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    font-weight: 600;
}

.file-item {
    border-bottom: 1px solid #f3f4f6;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.file-item:last-child { border-bottom: none; }

.file-checkbox { margin-right: 0.5rem; }

.file-details {
    flex: 1;
    min-width: 0;
}

.file-name {
    font-weight: 600;
    font-size: 0.8rem;
    margin-bottom: 0.2rem;
    word-break: break-word;
}

.file-meta {
    font-size: 0.7rem;
    color: var(--gray);
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.file-actions {
    display: flex;
    gap: 0.2rem;
    flex-wrap: wrap;
}

.loading {
    text-align: center;
    padding: 2rem;
}

.spinner {
    width: 24px;
    height: 24px;
    border: 2px solid #e5e7eb;
    border-top: 2px solid var(--red);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 0.5rem;
}

@keyframes spin { to { transform: rotate(360deg); } }

.empty {
    text-align: center;
    padding: 2rem;
    color: var(--gray);
    display: none;
}

.empty.show { display: block; }

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 1rem;
}

.modal.show { display: flex; }

.modal-content {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    width: 100%;
    max-width: 350px;
}

.modal-title {
    font-weight: 600;
    margin-bottom: 1rem;
}

.modal-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.modal-btn {
    flex: 1;
    padding: 0.5rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

/* Toast */
.toast {
    position: fixed;
    top: 1rem;
    left: 1rem;
    right: 1rem;
    background: white;
    padding: 0.75rem;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-100px);
    transition: transform 0.3s;
    z-index: 1001;
    font-size: 0.8rem;
}

.toast.show { transform: translateY(0); }
.toast.success { border-left: 3px solid var(--green); }
.toast.error { border-left: 3px solid var(--red); }

.delete-btn {
    background: var(--red);
    color: white;
    padding: 0.5rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin: 0.5rem;
    display: none;
}

.delete-btn.show { display: block; }
</style>
</head>
<body>
    <!-- Login -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1 class="login-title">üîê Admin Login</h1>
            <p style="margin-bottom: 1rem; font-size: 0.8rem; color: var(--gray);">Key: MSMxMarya7</p>
            <form onsubmit="return login(event)">
                <input type="password" id="adminKey" class="login-input" placeholder="Enter Admin Key" required>
                <button type="submit" class="login-btn" id="loginBtn">Access Admin</button>
                <div id="loginError" class="login-error">Invalid key</div>
            </form>
        </div>
    </div>

    <!-- Admin -->
    <div id="adminDashboard" class="admin-dashboard">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>üìÅ File Admin</h1>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>

            <!-- Stats -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalFiles">0</div>
                    <div class="stat-label">Files</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="selectedCount">0</div>
                    <div class="stat-label">Selected</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <input type="text" id="searchInput" class="search-input" placeholder="Search files...">
                <button class="btn" onclick="loadFiles()">üîÑ Refresh</button>
                <button id="deleteBtn" class="delete-btn" onclick="deleteSelected()">üóëÔ∏è Delete Selected</button>
            </div>

            <!-- Files -->
            <div class="files-section">
                <div class="section-header">
                    <input type="checkbox" id="selectAll" onchange="toggleAll()"> Files
                </div>

                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Loading...</p>
                </div>

                <div id="filesList"></div>

                <div id="empty" class="empty">
                    <p>üìÇ No files found</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Delete Files?</h3>
            <p style="font-size: 0.8rem; margin-bottom: 1rem;">Permanently delete <span id="deleteCount">0</span> file(s)?</p>
            <div class="modal-actions">
                <button class="modal-btn" style="background: #e5e7eb;" onclick="closeModal()">Cancel</button>
                <button class="modal-btn" style="background: var(--red); color: white;" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        // Globals
        let ADMIN_KEY = 'MSMxMarya7';
        let files = [];
        let selected = new Set();
        let deleteQueue = [];
        
        // Auth
        function login(e) {
            e.preventDefault();
            const key = document.getElementById('adminKey').value.trim();
            const btn = document.getElementById('loginBtn');
            const error = document.getElementById('loginError');
            
            btn.disabled = true;
            btn.textContent = 'Checking...';
            error.style.display = 'none';
            
            setTimeout(() => {
                if (key === ADMIN_KEY) {
                    localStorage.setItem('adminAuth', 'true');
                    localStorage.setItem('adminTime', Date.now());
                    showDashboard();
                    showToast('Login successful', 'success');
                } else {
                    error.style.display = 'block';
                    document.getElementById('adminKey').value = '';
                }
                btn.disabled = false;
                btn.textContent = 'Access Admin';
            }, 800);
            
            return false;
        }
        
        function checkAuth() {
            const auth = localStorage.getItem('adminAuth');
            const time = localStorage.getItem('adminTime');
            
            if (auth === 'true' && time) {
                const elapsed = Date.now() - parseInt(time);
                if (elapsed < 4 * 60 * 60 * 1000) { // 4 hours
                    showDashboard();
                    return;
                }
            }
            
            document.getElementById('loginScreen').style.display = 'flex';
        }
        
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminDashboard').classList.add('show');
            loadFiles();
            setupSearch();
        }
        
        function logout() {
            localStorage.removeItem('adminAuth');
            localStorage.removeItem('adminTime');
            location.reload();
        }
        
        // Load files (SIMPLIFIED - No Worker Limits)
        async function loadFiles() {
            console.log('üîÑ Loading files...');
            showLoading(true);
            
            try {
                const response = await fetch('/admin/list-files', {
                    headers: { 'Authorization': `Bearer ${ADMIN_KEY}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üìä API Response:', data);
                
                if (data.success) {
                    // ACCEPT ALL FILE FORMATS - Not just MSM
                    files = (data.files || []).filter(f => f && f.filename && f.id);
                    
                    console.log('üìÅ Files loaded:', files.length);
                    console.log('üìÅ Sample files:', files.slice(0, 3));
                    
                    displayFiles(files);
                    updateStats();
                } else {
                    throw new Error(data.error || 'API failed');
                }
                
            } catch (error) {
                console.error('‚ùå Load error:', error);
                showToast(`Load failed: ${error.message}`, 'error');
                showEmpty();
            } finally {
                showLoading(false);
            }
        }
        
        // Display files
        function displayFiles(filesList) {
            const container = document.getElementById('filesList');
            
            if (!filesList || filesList.length === 0) {
                showEmpty();
                return;
            }
            
            container.innerHTML = '';
            document.getElementById('empty').classList.remove('show');
            
            filesList.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <input type="checkbox" class="file-checkbox" value="${file.id}" onchange="toggleFile('${file.id}')">
                    <div class="file-details">
                        <div class="file-name">${truncate(file.filename, 40)}</div>
                        <div class="file-meta">
                            <span>üìä ${formatSize(file.size || 0)}</span>
                            <span>üÜî ${truncate(file.id, 12)}</span>
                            <span>üìÖ ${formatDate(file.uploadedAt)}</span>
                        </div>
                    </div>
                    <div class="file-actions">
                        <a href="/btfstorage/file/${file.id}" target="_blank" class="btn-sm btn-blue">View</a>
                        <a href="/btfstorage/file/${file.id}?dl=1" class="btn-sm btn-green">Download</a>
                        <button onclick="deleteFile('${file.id}', '${file.filename.replace(/'/g, '\\\'')}')" class="btn-sm" style="background: var(--red); color: white;">Delete</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        // File selection
        function toggleAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.file-checkbox');
            
            selected.clear();
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
                if (selectAll.checked && cb.value) {
                    selected.add(cb.value);
                }
            });
            
            updateSelectionUI();
        }
        
        function toggleFile(fileId) {
            if (selected.has(fileId)) {
                selected.delete(fileId);
            } else {
                selected.add(fileId);
            }
            updateSelectionUI();
        }
        
        function updateSelectionUI() {
            document.getElementById('selectedCount').textContent = selected.size;
            const deleteBtn = document.getElementById('deleteBtn');
            
            if (selected.size > 0) {
                deleteBtn.classList.add('show');
                deleteBtn.innerHTML = `üóëÔ∏è Delete ${selected.size} Selected`;
            } else {
                deleteBtn.classList.remove('show');
            }
        }
        
        // Delete functions
        function deleteFile(id, filename) {
            deleteQueue = [{ id, filename }];
            showDeleteModal();
        }
        
        function deleteSelected() {
            if (selected.size === 0) return;
            
            deleteQueue = Array.from(selected).map(id => {
                const file = files.find(f => f.id === id);
                return { id, filename: file ? file.filename : 'Unknown' };
            });
            
            showDeleteModal();
        }
        
        function showDeleteModal() {
            document.getElementById('deleteCount').textContent = deleteQueue.length;
            document.getElementById('deleteModal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('deleteModal').classList.remove('show');
            deleteQueue = [];
        }
        
        // FIXED DELETE - Accept ANY file ID format
        async function confirmDelete() {
            if (deleteQueue.length === 0) return;
            
            try {
                closeModal();
                showToast('Deleting files...', 'success');
                
                // ACCEPT ALL IDs - No MSM filtering
                const fileIds = deleteQueue.map(f => f.id).filter(id => id && id.trim());
                
                console.log('üóëÔ∏è Deleting files:', fileIds);
                
                if (fileIds.length === 0) {
                    throw new Error('No valid file IDs');
                }
                
                const response = await fetch('/admin/delete-files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ADMIN_KEY}`
                    },
                    body: JSON.stringify({ fileIds })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('üóëÔ∏è Delete result:', result);
                
                if (result.success) {
                    showToast(`‚úÖ Deleted ${result.deletedCount} files`, 'success');
                    
                    // Clear selection
                    selected.clear();
                    document.getElementById('selectAll').checked = false;
                    updateSelectionUI();
                    
                    // Reload
                    setTimeout(loadFiles, 1000);
                } else {
                    throw new Error(result.error || 'Delete failed');
                }
                
            } catch (error) {
                console.error('‚ùå Delete error:', error);
                showToast(`Delete failed: ${error.message}`, 'error');
            }
        }
        
        // Search
        function setupSearch() {
            document.getElementById('searchInput').addEventListener('input', e => {
                const query = e.target.value.toLowerCase();
                const filtered = files.filter(f => 
                    f.filename.toLowerCase().includes(query) || 
                    f.id.toLowerCase().includes(query)
                );
                displayFiles(filtered);
            });
        }
        
        // Update stats
        function updateStats() {
            document.getElementById('totalFiles').textContent = files.length;
        }
        
        // Utility functions
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showEmpty() {
            document.getElementById('empty').classList.add('show');
            document.getElementById('filesList').innerHTML = '';
        }
        
        function formatSize(bytes) {
            if (!bytes) return '0B';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + sizes[i];
        }
        
        function formatDate(timestamp) {
            return timestamp ? new Date(timestamp).toLocaleDateString() : 'Unknown';
        }
        
        function truncate(text, len) {
            if (!text) return 'Unknown';
            return text.length > len ? text.substring(0, len) + '...' : text;
        }
        
        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', checkAuth);
        
        console.log('‚úÖ Lite Admin Panel Ready');
    </script>
</body>
</html>
