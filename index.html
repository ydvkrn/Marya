<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 MARYA VAULT ULTIMATE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #dc2626; --primary-dark: #b91c1c; --primary-light: #fef2f2;
            --success: #059669; --error: #dc2626; --warning: #f59e0b;
            --white: #ffffff; --gray-50: #f9fafb; --gray-100: #f3f4f6; 
            --gray-200: #e5e7eb; --gray-600: #4b5563; --gray-900: #111827;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--white), var(--gray-50));
            min-height: 100vh; color: var(--gray-900);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .header { text-align: center; margin-bottom: 3rem; }
        .logo {
            width: 100px; height: 100px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 25px; margin: 0 auto 1.5rem;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(220, 38, 38, 0.3);
        }
        .title { font-size: 3rem; font-weight: 900; color: var(--primary); margin-bottom: 0.5rem; }
        .subtitle { font-size: 1.1rem; color: var(--gray-600); }
        .upload-section {
            background: var(--white); border-radius: 20px;
            padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 2rem;
        }
        .tabs {
            display: flex; gap: 1rem; margin-bottom: 2rem;
            background: var(--gray-100); border-radius: 12px; padding: 0.5rem;
        }
        .tab {
            flex: 1; padding: 1rem; border: none; background: transparent;
            cursor: pointer; font-weight: 600; border-radius: 8px; transition: all 0.3s;
        }
        .tab.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .dropzone {
            border: 3px dashed var(--gray-200); border-radius: 15px;
            padding: 3rem; text-align: center; cursor: pointer;
            transition: all 0.3s; min-height: 300px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .dropzone:hover { border-color: var(--primary); background: var(--primary-light); }
        .upload-icon { font-size: 4rem; color: var(--primary); margin-bottom: 1rem; }
        .url-section { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .url-input {
            flex: 1; padding: 1rem; border: 2px solid var(--gray-200);
            border-radius: 10px; font-size: 1rem;
        }
        .url-btn {
            background: var(--primary); color: white; padding: 1rem 2rem;
            border: none; border-radius: 10px; font-weight: 600;
            cursor: pointer; transition: all 0.3s;
        }
        .url-btn:hover { background: var(--primary-dark); }
        .url-btn:disabled {
            background: var(--gray-200); color: var(--gray-600); cursor: not-allowed;
        }
        .file-item {
            background: white; border-radius: 15px; padding: 1.5rem;
            margin-bottom: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary);
        }
        .file-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .file-icon {
            width: 60px; height: 60px; border-radius: 10px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.5rem;
        }
        .file-info { flex: 1; }
        .file-name { font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem; }
        .file-size { color: var(--gray-600); font-size: 0.9rem; }
        .file-status { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; margin-top: 0.5rem; }
        .file-status.uploading { color: var(--primary); }
        .file-status.completed { color: var(--success); }
        .file-status.failed { color: var(--error); }
        .progress-bar {
            width: 100%; height: 8px; background: var(--gray-200);
            border-radius: 10px; overflow: hidden; margin-bottom: 1rem;
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--primary), var(--success));
            transition: width 0.3s;
        }
        .progress-info {
            display: flex; justify-content: space-between; font-size: 0.875rem;
            color: var(--gray-600); margin-bottom: 0.5rem;
        }
        .file-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; }
        .btn {
            padding: 0.75rem 1.5rem; border: none; border-radius: 8px;
            font-weight: 600; cursor: pointer; transition: all 0.3s;
            text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: white; color: var(--gray-900); border: 2px solid var(--gray-200); }
        .error-details {
            background: #fff1f0; border: 1px solid #ffccc7; border-radius: 8px;
            padding: 1rem; margin-top: 1rem; font-size: 0.875rem; color: #cf1322;
        }
        .toast {
            position: fixed; top: 2rem; right: 2rem; background: white;
            padding: 1rem 1.5rem; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000; transform: translateX(120%); transition: all 0.3s; max-width: 400px;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--error); }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-cloud" style="font-size: 3rem; color: white;"></i>
            </div>
            <h1 class="title">🚀 MARYA VAULT</h1>
            <p class="subtitle">Ultra-Fast Storage • Auto-Chunking • Up to 2GB</p>
        </header>

        <section class="upload-section">
            <div class="tabs">
                <button class="tab active" onclick="showTab('file')">
                    <i class="fas fa-upload"></i> File Upload
                </button>
                <button class="tab" onclick="showTab('url')">
                    <i class="fas fa-link"></i> URL Upload
                </button>
            </div>

            <div class="tab-content active" id="file-content">
                <label class="dropzone" for="fileInput">
                    <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <h2>Drop files here or click to browse</h2>
                    <p style="color: var(--gray-600); margin-top: 0.5rem;">
                        Auto-chunks files > 50MB • Supports up to 2GB
                    </p>
                </label>
                <input type="file" id="fileInput" multiple style="display: none;">
            </div>

            <div class="tab-content" id="url-content">
                <div class="url-section">
                    <input type="url" id="urlInput" class="url-input" 
                           placeholder="Enter file URL (https://example.com/file.zip)">
                    <button class="url-btn" id="urlBtn" onclick="uploadFromUrl()">
                        <i class="fas fa-download"></i> Upload
                    </button>
                </div>
                <p style="text-align: center; color: var(--gray-600);">
                    Paste any direct file URL • Auto-retry on failures • Up to 2GB
                </p>
            </div>
        </section>

        <div id="filesList"></div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        console.log('🚀 MARYA VAULT - Ultra-Robust Version');

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => uploadFile(file));
            e.target.value = '';
        });

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + '-content').classList.add('active');
        }

        function uploadFile(file) {
            console.log('📤 Starting upload:', file.name, formatBytes(file.size));

            if (file.size > 2147483648) {
                showToast('File too large (max 2GB)', 'error');
                return;
            }

            const fileItem = createFileItem(file);
            document.getElementById('filesList').prepend(fileItem);

            const formData = new FormData();
            formData.append('file', file);

            const xhr = new XMLHttpRequest();
            const startTime = Date.now();

            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    const speed = e.loaded / ((Date.now() - startTime) / 1000);
                    updateProgress(fileItem, percent, speed);
                }
            });

            xhr.addEventListener('load', () => {
                console.log('📥 Response:', xhr.status, xhr.responseText.substring(0, 200));

                if (xhr.status === 200) {
                    try {
                        const result = JSON.parse(xhr.responseText);

                        if (result.success && result.filename) {
                            const fileUrl = `${window.location.origin}/btfstorage/file/${result.filename}`;

                            console.log('✅ Upload success! URL:', fileUrl);

                            handleUploadSuccess(fileItem, {
                                url: fileUrl,
                                filename: result.originalName || file.name,
                                size: result.size || file.size,
                                uploadType: result.uploadType || 'single',
                                chunks: result.chunks || 0
                            });

                            showToast(`✅ ${file.name} uploaded!`, 'success');
                        } else {
                            throw new Error(result.error || 'No filename in response');
                        }
                    } catch (error) {
                        console.error('❌ Parse error:', error);
                        handleUploadError(fileItem, error.message, xhr.responseText);
                    }
                } else {
                    console.error('❌ HTTP error:', xhr.status);
                    handleUploadError(fileItem, `Server error: ${xhr.status}`, xhr.responseText);
                }
            });

            xhr.addEventListener('error', () => {
                console.error('❌ Network error');
                handleUploadError(fileItem, 'Network error - Check connection');
            });

            xhr.open('POST', '/upload');
            xhr.send(formData);
        }

        async function uploadFromUrl() {
            const urlInput = document.getElementById('urlInput');
            const urlBtn = document.getElementById('urlBtn');
            const url = urlInput.value.trim();

            if (!url) {
                showToast('Please enter a URL', 'error');
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showToast('URL must start with http:// or https://', 'error');
                return;
            }

            console.log('🌐 Starting URL upload:', url);

            urlBtn.disabled = true;
            urlBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

            try {
                const response = await fetch('/upload-from-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                const responseText = await response.text();
                console.log('📥 Response:', response.status, responseText.substring(0, 200));

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch {
                    throw new Error('Invalid response from server');
                }

                if (result.success && result.filename) {
                    const fileUrl = `${window.location.origin}/btfstorage/file/${result.filename}`;

                    console.log('✅ URL upload success! URL:', fileUrl);

                    const fileItem = createCompletedFileItem({
                        url: fileUrl,
                        filename: result.originalName || 'download',
                        size: result.size || 0,
                        uploadType: result.uploadType || 'single',
                        chunks: result.chunks || 0
                    });

                    document.getElementById('filesList').prepend(fileItem);
                    showToast('🚀 URL upload completed!', 'success');
                    urlInput.value = '';
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('❌ URL upload error:', error);
                showToast(`❌ URL upload failed: ${error.message}`, 'error');
            } finally {
                urlBtn.disabled = false;
                urlBtn.innerHTML = '<i class="fas fa-download"></i> Upload';
            }
        }

        function createFileItem(file) {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `
                <div class="file-header">
                    <div class="file-icon">${getFileIcon(file.name)}</div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatBytes(file.size)}</div>
                        <div class="file-status uploading">
                            <i class="fas fa-spinner fa-spin"></i> Uploading...
                        </div>
                    </div>
                </div>
                <div class="progress-info">
                    <span class="progress-percent">0%</span>
                    <span class="progress-speed">0 MB/s</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="file-actions"></div>
            `;
            return div;
        }

        function createCompletedFileItem(data) {
            const div = document.createElement('div');
            div.className = 'file-item';
            const uploadInfo = data.uploadType === 'chunked' ? ` • ${data.chunks} chunks` : '';
            div.innerHTML = `
                <div class="file-header">
                    <div class="file-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="file-info">
                        <div class="file-name">${data.filename}</div>
                        <div class="file-size">${formatBytes(data.size)}${uploadInfo}</div>
                        <div class="file-status completed">
                            <i class="fas fa-check-circle"></i> Complete
                        </div>
                    </div>
                </div>
                <div class="file-actions">
                    <a href="${data.url}" target="_blank" class="btn btn-primary">
                        <i class="fas fa-eye"></i> View
                    </a>
                    <a href="${data.url}?dl=1" class="btn btn-success">
                        <i class="fas fa-download"></i> Download
                    </a>
                    <button onclick="copyToClipboard('${data.url}')" class="btn btn-outline">
                        <i class="fas fa-copy"></i> Copy Link
                    </button>
                </div>
            `;
            return div;
        }

        function updateProgress(fileItem, percent, speed) {
            fileItem.querySelector('.progress-fill').style.width = percent + '%';
            fileItem.querySelector('.progress-percent').textContent = percent + '%';
            fileItem.querySelector('.progress-speed').textContent = formatBytes(speed) + '/s';
        }

        function handleUploadSuccess(fileItem, data) {
            const progressBar = fileItem.querySelector('.progress-bar');
            const progressInfo = fileItem.querySelector('.progress-info');
            progressBar.remove();
            progressInfo.remove();

            const icon = fileItem.querySelector('.file-icon i');
            icon.className = 'fas fa-check-circle';

            const status = fileItem.querySelector('.file-status');
            const uploadInfo = data.uploadType === 'chunked' ? ` (${data.chunks} chunks)` : '';
            status.innerHTML = `<i class="fas fa-check-circle"></i> Complete${uploadInfo}`;
            status.className = 'file-status completed';

            const actions = fileItem.querySelector('.file-actions');
            actions.innerHTML = `
                <a href="${data.url}" target="_blank" class="btn btn-primary">
                    <i class="fas fa-eye"></i> View
                </a>
                <a href="${data.url}?dl=1" class="btn btn-success">
                    <i class="fas fa-download"></i> Download
                </a>
                <button onclick="copyToClipboard('${data.url}')" class="btn btn-outline">
                    <i class="fas fa-copy"></i> Copy Link
                </button>
            `;
        }

        function handleUploadError(fileItem, errorMsg, responseText = '') {
            const progressBar = fileItem.querySelector('.progress-bar');
            const progressInfo = fileItem.querySelector('.progress-info');
            progressBar?.remove();
            progressInfo?.remove();

            const icon = fileItem.querySelector('.file-icon i');
            icon.className = 'fas fa-exclamation-triangle';
            icon.parentElement.style.background = 'var(--error)';

            const status = fileItem.querySelector('.file-status');
            status.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Failed: ${errorMsg}`;
            status.className = 'file-status failed';

            if (responseText) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-details';
                errorDiv.innerHTML = `
                    <strong>Error Details:</strong><br>
                    ${responseText.substring(0, 500)}
                `;
                fileItem.appendChild(errorDiv);
            }
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop()?.toLowerCase() || '';
            const map = {
                'jpg': 'fa-image', 'jpeg': 'fa-image', 'png': 'fa-image', 'gif': 'fa-image',
                'mp4': 'fa-video', 'mkv': 'fa-video', 'avi': 'fa-video',
                'mp3': 'fa-music', 'wav': 'fa-music',
                'pdf': 'fa-file-pdf', 'doc': 'fa-file-word',
                'zip': 'fa-file-archive', 'rar': 'fa-file-archive'
            };
            return `<i class="fas ${map[ext] || 'fa-file'}"></i>`;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast('✅ Link copied!', 'success');
            } catch {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('✅ Link copied!', 'success');
            }
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.innerHTML = `<div><strong>${type === 'success' ? '✅ Success' : '❌ Error'}</strong><br>${message}</div>`;
            toast.className = `toast ${type}`;
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => toast.classList.remove('show'), 4000);
        }
    </script>
</body>
</html>