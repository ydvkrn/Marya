<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chunked File Upload</title>
  <style> /* White/Red pro design... */ </style>
</head>
<body>
  <div class="card">
    <h1>ðŸ“¦ Large File Chunk Upload</h1>
    <input type="file" id="fileInput" />
    <button onclick="uploadFile()" class="btn">Upload</button>
    <input id="urlInput" placeholder="Paste direct .mp4/.zip/.jpg file link" style="width:90%"><br>
    <button onclick="uploadFromUrl()" class="btn">Upload via URL</button>
    <div id="progress"></div>
    <div id="result"></div>
  </div>
<script>
const CHUNK_SIZE = 20 * 1024 * 1024;
async function uploadFile() {
  const file = document.getElementById('fileInput').files[0];
  if (!file) return alert("Select a file!");
  let total = file.size, uploaded = 0, chunkCount = Math.ceil(total/CHUNK_SIZE);
  let id = Math.random().toString(36).slice(2,12)+Date.now().toString(36);
  for (let i=0; i<chunkCount; i++) {
    const chunk = file.slice(i*CHUNK_SIZE, (i+1)*CHUNK_SIZE);
    const form = new FormData();
    form.append("chunk", chunk);
    form.append("id", id);
    form.append("idx", i);
    form.append("total", chunkCount);
    form.append("filename", file.name);
    let res = await fetch("/api/upload-chunk", {method:"POST", body:form});
    if(!res.ok) return alert("Upload failed chunk "+i);
    document.getElementById("progress").innerText = `Uploading ${i+1}/${chunkCount} ...`;
    uploaded += chunk.size;
  }
  document.getElementById("progress").innerText = "";
  document.getElementById("result").innerHTML = `âœ… Uploaded! <a href="/btfstorage/file/${id}_${file.name}">Direct Link</a>`;
}
// URL upload (fetches and chunks in Worker)
async function uploadFromUrl() {
  let url = document.getElementById('urlInput').value.trim();
  if (!url) return alert("Paste a valid url");
  const res = await fetch("/api/upload-from-url", {
    method:"POST",
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ url })
  });
  if (!res.ok) return alert("Upload failed: "+(await res.text()));
  const data = await res.json();
  document.getElementById("result").innerHTML = `âœ… Uploaded! <a href="${data.link}">Direct Link</a>`;
}
</script>
</body>
</html>
