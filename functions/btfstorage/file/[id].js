// functions/btfstorage/file/[id].js
const MIME_TYPES={mp4:"video/mp4",mkv:"video/x-matroska",avi:"video/x-msvideo",mov:"video/quicktime",m4v:"video/mp4",wmv:"video/x-ms-wmv",flv:"video/x-flv","3gp":"video/3gpp",webm:"video/webm",ogv:"video/ogg",mp3:"audio/mpeg",wav:"audio/wav",aac:"audio/mp4",m4a:"audio/mp4",ogg:"audio/ogg",flac:"audio/flac",wma:"audio/x-ms-wma",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",svg:"image/svg+xml",bmp:"image/bmp",tiff:"image/tiff",pdf:"application/pdf",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",txt:"text/plain",zip:"application/zip",rar:"application/x-rar-compressed",m3u8:"application/x-mpegURL",ts:"video/mp2t",mpd:"application/dash+xml"};export async function onRequest(e){const{request:t,env:n,params:r}=e,o=r.id;if(console.log("üé¨ Streaming:",o),"OPTIONS"===t.method)return new Response(null,{status:204,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, HEAD, OPTIONS","Access-Control-Allow-Headers":"Range, Content-Type","Access-Control-Max-Age":"86400","Access-Control-Expose-Headers":"Content-Length, Content-Range, Accept-Ranges"}});try{let e=o,r="",a=!1,s=!1,i=-1;if(o.includes(".")){const t=o.split(".");if(r=t.pop().toLowerCase(),e=t.join("."),"m3u8"===r)a=!0;else if("ts"===r&&e.includes("-")){const t=e.split("-"),n=t[t.length-1];isNaN(parseInt(n))||(i=parseInt(t.pop(),10),e=t.join("-"),s=!0)}}console.log("üìÇ ID:",e,"Ext:",r);const l=await n.FILES_KV.get(e);if(!l)return c("File not found",404);const u=JSON.parse(l);if(!u.filename||!u.size)return c("Invalid metadata",400);if(u.telegramFileId=u.telegramFileId||u.fileIdCode,!u.telegramFileId&&(!u.chunks||0===u.chunks.length))return c("Missing file source",400);const h=u.contentType||MIME_TYPES[r]||"application/octet-stream";return console.log("üì¶",u.filename,Math.round(u.size/1048576)+"MB"),a?d(t,n,u,e):s&&i>=0?m(n,u,i):u.telegramFileId&&(!u.chunks||0===u.chunks.length)?f(t,n,u,h):u.chunks&&u.chunks.length>0?p(t,n,u,h):c("Invalid configuration",400)}catch(e){return console.error("‚ùå Error:",e.message),c(e.message,500)}}async function d(e,t,n,r){if(!n.chunks||0===n.chunks.length)return c("HLS not supported",400);const o=new URL(e.url).origin;let a="#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:6
#EXT-X-MEDIA-SEQUENCE:0
#EXT-X-PLAYLIST-TYPE:VOD
";for(let e=0;e<n.chunks.length;e++)a+="#EXTINF:6.0,
",a+=`${o}/btfstorage/file/${r}-${e}.ts
`;return a+="#EXT-X-ENDLIST
",new Response(a,{status:200,headers:{"Content-Type":"application/x-mpegURL","Access-Control-Allow-Origin":"*","Cache-Control":"no-cache"}})}async function m(e,t,n){if(!t.chunks||n>=t.chunks.length)return c("Segment not found",404);try{const r=await g(e,t.chunks[n]);return new Response(r,{status:200,headers:{"Content-Type":"video/mp2t","Content-Length":r.byteLength.toString(),"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=31536000","Accept-Ranges":"bytes"}})}catch(e){return c(e.message,500)}}async function f(e,t,n,r){const o=[t.BOT_TOKEN,t.BOT_TOKEN2,t.BOT_TOKEN3,t.BOT_TOKEN4].filter(Boolean);for(const a of o)try{const o=await fetch(`https://api.telegram.org/bot${a}/getFile?file_id=${encodeURIComponent(n.telegramFileId)}`,{signal:AbortSignal.timeout(1e4)}),s=await o.json();if(!s.ok||!s.result?.file_path)continue;const i=`https://api.telegram.org/file/bot${a}/${s.result.file_path}`,l={},c=e.headers.get("Range");c&&(l.Range=c);const u=await fetch(i,{headers:l,signal:AbortSignal.timeout(3e4)});if(!u.ok)continue;const h=new Headers;return h.set("Content-Type",r),h.set("Access-Control-Allow-Origin","*"),h.set("Accept-Ranges","bytes"),h.set("Cache-Control","public, max-age=31536000"),h.set("Content-Disposition","inline"),u.headers.get("content-length")&&h.set("Content-Length",u.headers.get("content-length")),u.headers.get("content-range")&&h.set("Content-Range",u.headers.get("content-range")),console.log("‚úÖ Single file success"),new Response(u.body,{status:u.status,headers:h})}catch(e){continue}return c("All bots failed",503)}async function p(e,t,n,r){const o=n.chunks,a=n.size,s=e.headers.get("Range");return console.log("üß©",o.length,"chunks"),s?y(e,t,n,s,r,n.chunkSize||20971520):w(t,n,r)}async function y(e,t,n,r,o,a){const s=n.size,i=n.chunks,l=r.match(/bytes=(d+)-(d*)/);if(!l)return c("Invalid range",416,{"Content-Range":`bytes */${s}`});const u=parseInt(l[1],10);let h=l[2]?parseInt(l[2],10):s-1;if(h>=s&&(h=s-1),u>=s||u>h)return c("Range not satisfiable",416,{"Content-Range":`bytes */${s}`});const d=h-u+1,m=Math.floor(u/a),f=Math.floor(h/a);console.log("üéØ Range:",u,"-",h);let p=m,y=m*a;const{readable:w,writable:b}=new TransformStream,C=b.getWriter();return(async()=>{try{for(;p<=f;){const e=await g(t,i[p]),n=new Uint8Array(e),r=Math.max(u-y,0),o=Math.min(n.length,h-y+1);r<o&&await C.write(n.slice(r,o)),y+=a,p++,y>h&&break}await C.close()}catch(e){console.error("‚ùå",e.message),await C.abort(e).catch(()=>{})}})(),new Response(w,{status:206,headers:{"Content-Type":o,"Content-Length":d.toString(),"Content-Range":`bytes ${u}-${h}/${s}`,"Accept-Ranges":"bytes","Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=31536000","Content-Disposition":"inline"}})}async function w(e,t,n){const r=t.chunks,o=t.size;let a=0;const{readable:s,writable:i}=new TransformStream,l=i.getWriter();return(async()=>{try{for(;a<r.length;){console.log("üì¶",a+1,"/",r.length);const t=await g(e,r[a]);await l.write(new Uint8Array(t)),a++}await l.close(),console.log("‚úÖ Stream complete")}catch(e){console.error("‚ùå",e.message),await l.abort(e).catch(()=>{})}})(),new Response(s,{status:200,headers:{"Content-Type":n,"Content-Length":o.toString(),"Accept-Ranges":"bytes","Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=31536000","Content-Disposition":"inline"}})}async function g(e,t){const n=e[t.kvNamespace]||e.FILES_KV,r=t.keyName||t.chunkKey,o=await n.get(r);if(!o)throw new Error("Chunk not found: "+r);const a=JSON.parse(o),s=a.telegramFileId||a.fileIdCode;if(a.directUrl)try{const e=await fetch(a.directUrl,{signal:AbortSignal.timeout(2e4)});if(e.ok)return e.arrayBuffer()}catch(e){console.log("üîÑ URL expired")}const i=[e.BOT_TOKEN,e.BOT_TOKEN2,e.BOT_TOKEN3,e.BOT_TOKEN4].filter(Boolean);for(const t of i)try{const o=await fetch(`https://api.telegram.org/bot${t}/getFile?file_id=${encodeURIComponent(s)}`,{signal:AbortSignal.timeout(1e4)}),i=await o.json();if(!i.ok||!i.result?.file_path)continue;const l=`https://api.telegram.org/file/bot${t}/${i.result.file_path}`,c=await fetch(l,{signal:AbortSignal.timeout(2e4)});if(c.ok)return n.put(r,JSON.stringify({...a,directUrl:l,lastRefreshed:Date.now()})).catch(()=>{}),c.arrayBuffer()}catch(e){continue}throw new Error("All bots failed for chunk")}function c(e,t=500,n={}){return new Response(JSON.stringify({error:e,status:t,timestamp:(new Date).toISOString()}),{status:t,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*",...n}})}