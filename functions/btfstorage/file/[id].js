// functions/btfstorage/file/[id].js
export async function onRequest(ctx){const{request,env,params}=ctx;if(request.method==='OPTIONS'){return new Response(null,{status:204,headers:{'Access-Control-Allow-Origin':'*','Access-Control-Allow-Methods':'GET, HEAD, OPTIONS','Access-Control-Allow-Headers':'Range, Content-Type','Access-Control-Max-Age':'86400','Access-Control-Expose-Headers':'Content-Length, Content-Range, Accept-Ranges'}})}try{const fileId=params.id;let actualId=fileId;let ext='';let isM3u8=false;let isTsSegment=false;let segIdx=-1;if(fileId.includes('.')){const idx=fileId.lastIndexOf('.');ext=fileId.substring(idx+1).toLowerCase();actualId=fileId.substring(0,idx);if(ext==='m3u8'){isM3u8=true}else if(ext==='ts'&&actualId.includes('-')){const parts=actualId.split('-');const last=parts[parts.length-1];if(!isNaN(parseInt(last))){segIdx=parseInt(last);parts.pop();actualId=parts.join('-');isTsSegment=true}}}console.log('File:',actualId,'Ext:',ext);const metaStr=await env.FILES_KV.get(actualId);if(!metaStr)return err('File not found',404);const meta=JSON.parse(metaStr);if(!meta.filename||!meta.size)return err('Invalid metadata',400);meta.telegramFileId=meta.telegramFileId||meta.fileIdCode;if(!meta.telegramFileId&&(!meta.chunks||!meta.chunks.length)){return err('No file source',400)}const mime=getMime(ext,meta.contentType);console.log('Size:',Math.round(meta.size/1e6)+'MB','Chunks:',meta.chunks?.length||0);if(isM3u8)return makeM3u8(request,meta,actualId);if(isTsSegment&&segIdx>=0)return getTsSegment(env,meta,segIdx);if(meta.telegramFileId&&(!meta.chunks||!meta.chunks.length)){return streamSingle(request,env,meta,mime)}if(meta.chunks&&meta.chunks.length){return streamChunks(request,env,meta,mime)}return err('Invalid config',400)}catch(e){console.error('Error:',e.message);return err(e.message,500)}}function getMime(ext,contentType){if(contentType)return contentType;const types={mp4:'video/mp4',mkv:'video/x-matroska',avi:'video/x-msvideo',mov:'video/quicktime',webm:'video/webm',mp3:'audio/mpeg',wav:'audio/wav',jpg:'image/jpeg',jpeg:'image/jpeg',png:'image/png',gif:'image/gif',pdf:'application/pdf',m3u8:'application/x-mpegURL',ts:'video/mp2t'};return types[ext]||'application/octet-stream'}function makeM3u8(req,meta,id){if(!meta.chunks||!meta.chunks.length)return err('No HLS support',400);const base=new URL(req.url).origin;let m3u='#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:6
#EXT-X-MEDIA-SEQUENCE:0
#EXT-X-PLAYLIST-TYPE:VOD
';for(let i=0;i<meta.chunks.length;i++){m3u+='#EXTINF:6.0,
'+base+'/btfstorage/file/'+id+'-'+i+'.ts
'}m3u+='#EXT-X-ENDLIST
';return new Response(m3u,{status:200,headers:{'Content-Type':'application/x-mpegURL','Access-Control-Allow-Origin':'*','Cache-Control':'no-cache'}})}async function getTsSegment(env,meta,idx){if(!meta.chunks||idx>=meta.chunks.length||idx<0){return err('Segment not found',404)}try{const data=await loadChunk(env,meta.chunks[idx]);return new Response(data,{status:200,headers:{'Content-Type':'video/mp2t','Content-Length':data.byteLength.toString(),'Access-Control-Allow-Origin':'*','Cache-Control':'public, max-age=31536000','Accept-Ranges':'bytes'}})}catch(e){return err(e.message,500)}}async function streamSingle(req,env,meta,mime){const bots=[env.BOT_TOKEN,env.BOT_TOKEN2,env.BOT_TOKEN3,env.BOT_TOKEN4].filter(Boolean);for(const bot of bots){try{const infoRes=await fetch('https://api.telegram.org/bot'+bot+'/getFile?file_id='+encodeURIComponent(meta.telegramFileId),{signal:AbortSignal.timeout(10000)});const info=await infoRes.json();if(!info.ok||!info.result?.file_path)continue;const url='https://api.telegram.org/file/bot'+bot+'/'+info.result.file_path;const h={};const range=req.headers.get('Range');if(range)h['Range']=range;const res=await fetch(url,{headers:h,signal:AbortSignal.timeout(30000)});if(!res.ok)continue;const headers=new Headers();headers.set('Content-Type',mime);headers.set('Access-Control-Allow-Origin','*');headers.set('Accept-Ranges','bytes');headers.set('Cache-Control','public, max-age=31536000');headers.set('Content-Disposition','inline');if(res.headers.get('content-length')){headers.set('Content-Length',res.headers.get('content-length'))}if(res.headers.get('content-range')){headers.set('Content-Range',res.headers.get('content-range'))}console.log('Single file OK');return new Response(res.body,{status:res.status,headers})}catch(e){continue}}return err('All bots failed',503)}async function streamChunks(req,env,meta,mime){const chunks=meta.chunks;const total=meta.size;const chunkSize=meta.chunkSize||20971520;const range=req.headers.get('Range');console.log('Chunks:',chunks.length,'Total:',Math.round(total/1e6)+'MB');if(range){return doRange(env,meta,range,mime,chunkSize)}return doFull(env,meta,mime)}async function doRange(env,meta,range,mime,chunkSize){const total=meta.size;const chunks=meta.chunks;const m=range.match(/bytes=(d+)-(d*)/);if(!m)return err('Invalid range',416,{'Content-Range':'bytes */'+total});const start=parseInt(m[1]);let end=m[2]?parseInt(m[2]):total-1;if(end>=total)end=total-1;if(start>=total||start>end){return err('Range not satisfiable',416,{'Content-Range':'bytes */'+total})}const size=end-start+1;const startChunk=Math.floor(start/chunkSize);const endChunk=Math.floor(end/chunkSize);console.log('Range:',start,'-',end,'(',Math.round(size/1e6)+'MB)');let idx=startChunk;let pos=startChunk*chunkSize;const{readable,writable}=new TransformStream();const w=writable.getWriter();(async()=>{try{while(idx<=endChunk){const data=await loadChunk(env,chunks[idx]);const bytes=new Uint8Array(data);const s=Math.max(start-pos,0);const e=Math.min(bytes.length,end-pos+1);if(s<e){await w.write(bytes.slice(s,e))}pos+=chunkSize;idx++;if(pos>end)break}await w.close()}catch(e){console.error('Range error:',e.message);try{await w.abort(e)}catch(_){}}})();return new Response(readable,{status:206,headers:{'Content-Type':mime,'Content-Length':size.toString(),'Content-Range':'bytes '+start+'-'+end+'/'+total,'Accept-Ranges':'bytes','Access-Control-Allow-Origin':'*','Cache-Control':'public, max-age=31536000','Content-Disposition':'inline'}})}async function doFull(env,meta,mime){const chunks=meta.chunks;const total=meta.size;let idx=0;const{readable,writable}=new TransformStream();const w=writable.getWriter();(async()=>{try{while(idx<chunks.length){const data=await loadChunk(env,chunks[idx]);await w.write(new Uint8Array(data));idx++}await w.close();console.log('Full stream done')}catch(e){console.error('Full stream error:',e.message);try{await w.abort(e)}catch(_){}}})();return new Response(readable,{status:200,headers:{'Content-Type':mime,'Content-Length':total.toString(),'Accept-Ranges':'bytes','Access-Control-Allow-Origin':'*','Cache-Control':'public, max-age=31536000','Content-Disposition':'inline'}})}async function loadChunk(env,info){const kv=env[info.kvNamespace]||env.FILES_KV;const key=info.keyName||info.chunkKey;const metaStr=await kv.get(key);if(!metaStr)throw new Error('Chunk not found: '+key);const meta=JSON.parse(metaStr);const fileId=meta.telegramFileId||meta.fileIdCode;if(meta.directUrl){try{const r=await fetch(meta.directUrl,{signal:AbortSignal.timeout(20000)});if(r.ok)return r.arrayBuffer()}catch(_){}}const bots=[env.BOT_TOKEN,env.BOT_TOKEN2,env.BOT_TOKEN3,env.BOT_TOKEN4].filter(Boolean);for(const bot of bots){try{const infoRes=await fetch('https://api.telegram.org/bot'+bot+'/getFile?file_id='+encodeURIComponent(fileId),{signal:AbortSignal.timeout(10000)});const info=await infoRes.json();if(!info.ok||!info.result?.file_path)continue;const url='https://api.telegram.org/file/bot'+bot+'/'+info.result.file_path;const r=await fetch(url,{signal:AbortSignal.timeout(20000)});if(r.ok){kv.put(key,JSON.stringify({...meta,directUrl:url,lastRefreshed:Date.now()})).catch(()=>{});return r.arrayBuffer()}}catch(_){continue}}throw new Error('All bots failed for chunk')}function err(msg,status=500,headers={}){return new Response(JSON.stringify({error:msg,status,timestamp:new Date().toISOString()}),{status,headers:{'Content-Type':'application/json','Access-Control-Allow-Origin':'*',...headers}})}