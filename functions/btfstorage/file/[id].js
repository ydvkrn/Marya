export async function onRequest(ctx){const{request:r,env:e,params:p}=ctx;if(r.method==="OPTIONS")return new Response(null,{status:204,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, HEAD, OPTIONS","Access-Control-Allow-Headers":"Range, Content-Type","Access-Control-Max-Age":"86400","Access-Control-Expose-Headers":"Content-Length, Content-Range, Accept-Ranges"}});try{const t=p.id;let a=t,s="",n=!1,o=!1,i=-1;if(t.includes(".")){const r=t.lastIndexOf(".");if(s=t.substring(r+1).toLowerCase(),a=t.substring(0,r),"m3u8"===s)n=!0;else if("ts"===s&&a.includes("-")){const r=a.split("-"),e=r[r.length-1];isNaN(parseInt(e))||(i=parseInt(e),r.pop(),a=r.join("-"),o=!0)}}console.log("File:",a,"Ext:",s);const c=await e.FILES_KV.get(a);if(!c)return l("File not found",404);const u=JSON.parse(c);if(!u.filename||!u.size)return l("Invalid metadata",400);if(u.telegramFileId=u.telegramFileId||u.fileIdCode,!u.telegramFileId&&(!u.chunks||!u.chunks.length))return l("No file source",400);const d=m(s,u.contentType);if(console.log("Size:",Math.round(u.size/1e6)+"MB","Chunks:",u.chunks?.length||0),n)return f(r,u,a);if(o&&i>=0)return h(e,u,i);if(u.telegramFileId&&(!u.chunks||!u.chunks.length))return g(r,e,u,d);if(u.chunks&&u.chunks.length)return w(r,e,u,d);return l("Invalid config",400)}catch(r){return console.error("Error:",r.message),l(r.message,500)}}function m(r,e){if(e)return e;const t={mp4:"video/mp4",mkv:"video/x-matroska",avi:"video/x-msvideo",mov:"video/quicktime",webm:"video/webm",mp3:"audio/mpeg",wav:"audio/wav",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",pdf:"application/pdf",m3u8:"application/x-mpegURL",ts:"video/mp2t"};return t[r]||"application/octet-stream"}function f(r,e,t){if(!e.chunks||!e.chunks.length)return l("No HLS support",400);const a=new URL(r.url).origin;let s="#EXTM3U
#EXT-X-VERSION:3
#EXT-X-TARGETDURATION:6
#EXT-X-MEDIA-SEQUENCE:0
#EXT-X-PLAYLIST-TYPE:VOD
";for(let r=0;r<e.chunks.length;r++)s+="#EXTINF:6.0,
"+a+"/btfstorage/file/"+t+"-"+r+".ts
";return s+="#EXT-X-ENDLIST
",new Response(s,{status:200,headers:{"Content-Type":"application/x-mpegURL","Access-Control-Allow-Origin":"*","Cache-Control":"no-cache"}})}async function h(r,e,t){if(!e.chunks||t>=e.chunks.length||t<0)return l("Segment not found",404);try{const a=await k(r,e.chunks[t]);return new Response(a,{status:200,headers:{"Content-Type":"video/mp2t","Content-Length":a.byteLength.toString(),"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=31536000","Accept-Ranges":"bytes"}})}catch(r){return l(r.message,500)}}async function g(r,e,t,a){const s=[e.BOT_TOKEN,e.BOT_TOKEN2,e.BOT_TOKEN3,e.BOT_TOKEN4].filter(Boolean);for(const n of s)try{const s=await fetch("https://api.telegram.org/bot"+n+"/getFile?file_id="+encodeURIComponent(t.telegramFileId),{signal:AbortSignal.timeout(1e4)}),o=await s.json();if(!o.ok||!o.result?.file_path)continue;const i="https://api.telegram.org/file/bot"+n+"/"+o.result.file_path,c={},u=r.headers.get("Range");u&&(c.Range=u);const d=await fetch(i,{headers:c,signal:AbortSignal.timeout(3e4)});if(!d.ok)continue;const m=new Headers;return m.set("Content-Type",a),m.set("Access-Control-Allow-Origin","*"),m.set("Accept-Ranges","bytes"),m.set("Cache-Control","public, max-age=31536000"),m.set("Content-Disposition","inline"),d.headers.get("content-length")&&m.set("Content-Length",d.headers.get("content-length")),d.headers.get("content-range")&&m.set("Content-Range",d.headers.get("content-range")),console.log("Single file OK"),new Response(d.body,{status:d.status,headers:m})}catch(r){continue}return l("All bots failed",503)}async function w(r,e,t,a){const s=t.chunks,n=t.size,o=t.chunkSize||20971520,i=r.headers.get("Range");return console.log("Chunks:",s.length,"Total:",Math.round(n/1e6)+"MB"),i?b(e,t,i,a,o):y(e,t,a)}async function b(r,e,t,a,s){const n=e.size,o=e.chunks,i=t.match(/bytes=(d+)-(d*)/);if(!i)return l("Invalid range",416,{"Content-Range":"bytes */"+n});const c=parseInt(i[1]);let u=i[2]?parseInt(i[2]):n-1;if(u>=n&&(u=n-1),c>=n||c>u)return l("Range not satisfiable",416,{"Content-Range":"bytes */"+n});const d=u-c+1,m=Math.floor(c/s),f=Math.floor(u/s);console.log("Range:",c,"-",u,"(",Math.round(d/1e6)+"MB)");let h=m,g=m*s;const{readable:w,writable:b}=new TransformStream,y=b.getWriter();return(async()=>{try{for(;h<=f;){const e=await k(r,o[h]),t=new Uint8Array(e),a=Math.max(c-g,0),s=Math.min(t.length,u-g+1);a<s&&await y.write(t.slice(a,s)),g+=s,h++,g>u&&break}await y.close()}catch(r){console.error("Range error:",r.message);try{await y.abort(r)}catch(r){}}})(),new Response(w,{status:206,headers:{"Content-Type":a,"Content-Length":d.toString(),"Content-Range":"bytes "+c+"-"+u+"/"+n,"Accept-Ranges":"bytes","Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=31536000","Content-Disposition":"inline"}})}async function y(r,e,t){const a=e.chunks,s=e.size;let n=0;const{readable:o,writable:i}=new TransformStream,c=i.getWriter();return(async()=>{try{for(;n<a.length;){const e=await k(r,a[n]);await c.write(new Uint8Array(e)),n++}await c.close(),console.log("Full stream done")}catch(r){console.error("Full stream error:",r.message);try{await c.abort(r)}catch(r){}}})(),new Response(o,{status:200,headers:{"Content-Type":t,"Content-Length":s.toString(),"Accept-Ranges":"bytes","Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=31536000","Content-Disposition":"inline"}})}async function k(r,e){const t=r[e.kvNamespace]||r.FILES_KV,a=e.keyName||e.chunkKey,s=await t.get(a);if(!s)throw new Error("Chunk not found: "+a);const n=JSON.parse(s),o=n.telegramFileId||n.fileIdCode;if(n.directUrl)try{const r=await fetch(n.directUrl,{signal:AbortSignal.timeout(2e4)});if(r.ok)return r.arrayBuffer()}catch(r){}const i=[r.BOT_TOKEN,r.BOT_TOKEN2,r.BOT_TOKEN3,r.BOT_TOKEN4].filter(Boolean);for(const e of i)try{const r=await fetch("https://api.telegram.org/bot"+e+"/getFile?file_id="+encodeURIComponent(o),{signal:AbortSignal.timeout(1e4)}),s=await r.json();if(!s.ok||!s.result?.file_path)continue;const i="https://api.telegram.org/file/bot"+e+"/"+s.result.file_path,c=await fetch(i,{signal:AbortSignal.timeout(2e4)});if(c.ok)return t.put(a,JSON.stringify({...n,directUrl:i,lastRefreshed:Date.now()})).catch(()=>{}),c.arrayBuffer()}catch(r){continue}throw new Error("All bots failed for chunk")}function l(r,e=500,t={}){return new Response(JSON.stringify({error:r,status:e,timestamp:(new Date).toISOString()}),{status:e,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*",...t}})}