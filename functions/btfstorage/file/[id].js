export async function onRequest(t){const{request:e,env:r,params:a}=t;if("OPTIONS"===e.method)return new Response(null,{status:204,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, HEAD, OPTIONS","Access-Control-Allow-Headers":"Range, Content-Type","Access-Control-Max-Age":"86400","Access-Control-Expose-Headers":"Content-Length, Content-Range, Accept-Ranges"}});try{const t=a.id;let s=t,n="",o=!1,c=!1,i=-1;if(t.includes(".")){const e=t.lastIndexOf(".");if(n=t.substring(e+1).toLowerCase(),s=t.substring(0,e),"m3u8"===n)o=!0;else if("ts"===n&&s.includes("-")){const e=s.split("-"),t=e[e.length-1];isNaN(parseInt(t))||(i=parseInt(t),e.pop(),s=e.join("-"),c=!0)}}console.log("ID:",s,"Ext:",n);const u=await r.FILES_KV.get(s);if(!u)return l("File not found",404);const d=JSON.parse(u);if(!d.filename||!d.size)return l("Bad metadata",400);if(d.telegramFileId=d.telegramFileId||d.fileIdCode,!d.telegramFileId&&(!d.chunks||!d.chunks.length))return l("No source",400);const f=m(n,d.contentType);if(console.log("File:",d.filename,"Size:",Math.round(d.size/1048576)+"MB"),o)return h(e,d,s);if(c&&i>=0)return g(r,d,i);if(d.telegramFileId&&(!d.chunks||!d.chunks.length))return w(e,r,d,f);if(d.chunks&&d.chunks.length)return b(e,r,d,f);return l("Invalid config",400)}catch(t){return console.error("Error:",t.message),l(t.message,500)}}function m(t,e){if(e)return e;const r={mp4:"video/mp4",mkv:"video/x-matroska",webm:"video/webm",avi:"video/x-msvideo",mov:"video/quicktime",mp3:"audio/mpeg",wav:"audio/wav",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",pdf:"application/pdf",zip:"application/zip",m3u8:"application/x-mpegURL",ts:"video/mp2t"};return r[t]||"application/octet-stream"}function h(t,e,r){if(!e.chunks||!e.chunks.length)return l("No HLS",400);const a=new URL(t.url).origin,s=["#EXTM3U","#EXT-X-VERSION:3","#EXT-X-TARGETDURATION:6","#EXT-X-MEDIA-SEQUENCE:0","#EXT-X-PLAYLIST-TYPE:VOD"];for(let t=0;t<e.chunks.length;t++)s.push("#EXTINF:6.0,"),s.push(a+"/btfstorage/file/"+r+"-"+t+".ts");return s.push("#EXT-X-ENDLIST"),new Response(s.join("
"),{status:200,headers:{"Content-Type":"application/x-mpegURL","Access-Control-Allow-Origin":"*","Cache-Control":"no-cache"}})}async function g(t,e,r){if(!e.chunks||r>=e.chunks.length||r<0)return l("Segment not found",404);try{const a=await k(t,e.chunks[r]);return new Response(a,{status:200,headers:{"Content-Type":"video/mp2t","Content-Length":a.byteLength.toString(),"Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=31536000","Accept-Ranges":"bytes"}})}catch(t){return l(t.message,500)}}async function w(t,e,r,a){const s=[e.BOT_TOKEN,e.BOT_TOKEN2,e.BOT_TOKEN3,e.BOT_TOKEN4].filter(Boolean);for(const n of s)try{const s=await fetch("https://api.telegram.org/bot"+n+"/getFile?file_id="+encodeURIComponent(r.telegramFileId),{signal:AbortSignal.timeout(1e4)}),o=await s.json();if(!o.ok||!o.result?.file_path)continue;const c="https://api.telegram.org/file/bot"+n+"/"+o.result.file_path,i={},u=t.headers.get("Range");u&&(i.Range=u);const d=await fetch(c,{headers:i,signal:AbortSignal.timeout(3e4)});if(!d.ok)continue;const f=new Headers;return f.set("Content-Type",a),f.set("Access-Control-Allow-Origin","*"),f.set("Accept-Ranges","bytes"),f.set("Cache-Control","public, max-age=31536000"),f.set("Content-Disposition","inline"),d.headers.get("content-length")&&f.set("Content-Length",d.headers.get("content-length")),d.headers.get("content-range")&&f.set("Content-Range",d.headers.get("content-range")),console.log("Single OK"),new Response(d.body,{status:d.status,headers:f})}catch(t){continue}return l("All bots failed",503)}async function b(t,e,r,a){const s=r.chunks,n=r.size,o=r.chunkSize||20971520,c=t.headers.get("Range");return console.log("Chunks:",s.length),c?y(e,r,c,a,o):p(e,r,a)}async function y(t,e,r,a,s){const n=e.size,o=e.chunks,c=r.match(/bytes=(d+)-(d*)/);if(!c)return l("Invalid range",416,{"Content-Range":"bytes */"+n});const i=parseInt(c[1]);let u=c[2]?parseInt(c[2]):n-1;if(u>=n&&(u=n-1),i>=n||i>u)return l("Not satisfiable",416,{"Content-Range":"bytes */"+n});const d=u-i+1,f=Math.floor(i/s),m=Math.floor(u/s);console.log("Range:",i,"-",u);let h=f,g=f*s;const{readable:w,writable:b}=new TransformStream,y=b.getWriter();return(async()=>{try{for(;h<=m;){const e=await k(t,o[h]),r=new Uint8Array(e),a=Math.max(i-g,0),s=Math.min(r.length,u-g+1);a<s&&await y.write(r.slice(a,s)),g+=s,h++,g>u&&break}await y.close()}catch(t){console.error("Range err:",t.message);try{await y.abort(t)}catch(t){}}})(),new Response(w,{status:206,headers:{"Content-Type":a,"Content-Length":d.toString(),"Content-Range":"bytes "+i+"-"+u+"/"+n,"Accept-Ranges":"bytes","Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=31536000","Content-Disposition":"inline"}})}async function p(t,e,r){const a=e.chunks,s=e.size;let n=0;const{readable:o,writable:c}=new TransformStream,i=c.getWriter();return(async()=>{try{for(;n<a.length;){const e=await k(t,a[n]);await i.write(new Uint8Array(e)),n++}await i.close(),console.log("Done")}catch(t){console.error("Full err:",t.message);try{await i.abort(t)}catch(t){}}})(),new Response(o,{status:200,headers:{"Content-Type":r,"Content-Length":s.toString(),"Accept-Ranges":"bytes","Access-Control-Allow-Origin":"*","Cache-Control":"public, max-age=31536000","Content-Disposition":"inline"}})}async function k(t,e){const r=t[e.kvNamespace]||t.FILES_KV,a=e.keyName||e.chunkKey,s=await r.get(a);if(!s)throw new Error("Chunk not found: "+a);const n=JSON.parse(s),o=n.telegramFileId||n.fileIdCode;if(n.directUrl)try{const t=await fetch(n.directUrl,{signal:AbortSignal.timeout(2e4)});if(t.ok)return t.arrayBuffer()}catch(t){}const c=[t.BOT_TOKEN,t.BOT_TOKEN2,t.BOT_TOKEN3,t.BOT_TOKEN4].filter(Boolean);for(const e of c)try{const t=await fetch("https://api.telegram.org/bot"+e+"/getFile?file_id="+encodeURIComponent(o),{signal:AbortSignal.timeout(1e4)}),s=await t.json();if(!s.ok||!s.result?.file_path)continue;const c="https://api.telegram.org/file/bot"+e+"/"+s.result.file_path,i=await fetch(c,{signal:AbortSignal.timeout(2e4)});if(i.ok)return r.put(a,JSON.stringify({...n,directUrl:c,lastRefreshed:Date.now()})).catch(()=>{}),i.arrayBuffer()}catch(t){continue}throw new Error("All bots failed")}function l(t,e=500,r={}){return new Response(JSON.stringify({error:t,status:e,timestamp:(new Date).toISOString()}),{status:e,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*",...r}})}