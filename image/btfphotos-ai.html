<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BTF Image AI 1.6V - Complete Fixed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    :root {
      --bg-main: #020617;
      --border-subtle: #0f172a;
      --border-strong: #1f2937;
      --primary: #38bdf8;
      --primary2: #a855f7;
      --accent-green: #4ade80;
      --accent-red: #f87171;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --radius-lg: 18px;
      --radius-md: 14px;
      --shadow-card: 0 20px 45px rgba(0, 0, 0, 0.7);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #0b1120 0, #020617 50%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 16px 40px;
    }

    .navbar {
      position: sticky;
      top: 0;
      z-index: 40;
      background: rgba(2, 6, 23, 0.96);
      border-bottom: 1px solid #020617;
      backdrop-filter: blur(10px);
    }

    .nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 16px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }

    .brand-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .brand-title span:first-child { color: #38bdf8; }
    .brand-title span:last-child { color: #a5b4fc; }

    .brand-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 0, #38bdf8, #6366f1 45%, #a855f7 100%);
      box-shadow: 0 0 18px rgba(56,189,248,0.7);
    }

    .brand-icon i { color: #020617; font-size: 14px; }

    .brand-sub {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .tabs {
      margin-top: 18px;
      display: flex;
      gap: 8px;
      background: #020617;
      border-radius: 999px;
      padding: 4px;
      border: 1px solid #0f172a;
    }

    .tab {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 13px;
      font-weight: 600;
      color: #9ca3af;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.12s ease, color 0.12s ease;
    }

    .tab i { font-size: 13px; }

    .tab.active {
      background: linear-gradient(90deg, #38bdf8, #a855f7);
      color: #020617;
    }

    /* TOOLS LAYOUT */
    .tools-layout {
      margin-top: 18px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    @media (min-width: 768px) {
      .tools-layout { grid-template-columns: minmax(0, 3fr) minmax(0, 2fr); }
    }

    .card {
      background: radial-gradient(circle at top, #020617 0, #020617 55%, #020617 100%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-card);
      padding: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title i { color: #38bdf8; font-size: 14px; }

    .card-sub {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .image-container {
      background: #020617;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 320px;
      position: relative;
    }

    .image-drop {
      border-radius: 14px;
      border: 2px dashed var(--border-strong);
      width: 100%;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      overflow: hidden;
    }

    .image-drop:hover {
      border-color: var(--primary);
      background: rgba(56, 189, 248, 0.05);
    }

    .image-drop-inner {
      text-align: center;
      padding: 24px 16px;
    }

    .image-drop-inner i {
      font-size: 40px;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #38bdf8, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .image-drop-inner h3 {
      font-size: 15px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .image-drop-inner p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .preview-wrapper { display: none; width: 100%; height: 100%; position: relative; }
    .preview-img, .result-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 12px;
      background: #020617;
    }

    .actions {
      margin-top: 16px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      width: 100%;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
      white-space: nowrap;
      flex: 1;
      min-width: 140px;
      justify-content: center;
    }

    .btn i { font-size: 14px; }

    .btn-enhance {
      background: linear-gradient(90deg, #22d3ee, #6366f1);
      color: #020617;
      box-shadow: 0 10px 25px rgba(56, 189, 248, 0.4);
    }

    .btn-bg {
      background: linear-gradient(90deg, #a855f7, #ec4899);
      color: #020617;
      box-shadow: 0 10px 25px rgba(236, 72, 153, 0.4);
    }

    .btn-generate {
      background: linear-gradient(90deg, #4ade80, #22c55e);
      color: #020617;
      box-shadow: 0 12px 30px rgba(34, 197, 94, 0.45);
      padding: 14px 28px;
      font-size: 15px;
      flex: 0 0 auto;
    }

    .btn-ratio, .btn-selector {
      background: linear-gradient(90deg, #38bdf8, #a855f7);
      color: #020617;
      box-shadow: 0 8px 20px rgba(56, 189, 248, 0.3);
      padding: 10px 16px;
      font-size: 13px;
      min-width: 110px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 15px 35px rgba(15, 23, 42, 0.8);
    }

    .status-bar {
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
      min-height: 20px;
      font-weight: 500;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid #1f2937;
      border-top-color: #38bdf8;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    .status-error { color: #fecaca; }

    .btn-download {
      background: transparent;
      border: 1px solid var(--border-strong);
      color: var(--text-main);
      padding: 12px 20px;
      font-size: 14px;
      margin-top: 12px;
      width: 100%;
      display: block !important;
    }

    .btn-download:hover { 
      background: rgba(56, 189, 248, 0.1);
      border-color: var(--primary);
    }

    .result-badge {
      position: absolute;
      bottom: 16px;
      right: 16px;
      z-index: 10;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      padding: 6px 10px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      backdrop-filter: blur(8px);
      font-size: 11px;
      font-weight: 600;
    }

    /* GENERATOR */
    #slideGenerator .card { display: flex; flex-direction: column; gap: 24px; }
    
    .gen-controls-top {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .gen-prompt-section {
      background: rgba(15, 23, 42, 0.6);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      padding: 24px;
      backdrop-filter: blur(8px);
    }

    .gen-prompt-label {
      font-size: 13px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .gen-prompt-input {
      width: 100%;
      min-height: 140px;
      background: rgba(2, 6, 23, 0.8);
      border-radius: var(--radius-md);
      border: 1px solid #334155;
      padding: 18px;
      font-size: 14px;
      color: var(--text-main);
      outline: none;
      font-weight: 500;
      resize: vertical;
      font-family: inherit;
    }

    .gen-prompt-input::placeholder { color: #6b7280; }
    .gen-prompt-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.15);
    }

    .selector-section {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }

    @media (max-width: 600px) {
      .selector-section { justify-content: center; }
      .btn-ratio, .btn-selector { flex: 1 1 100px; min-width: 90px; }
    }

    .gen-generate-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }

    .progress-circle {
      display: none;
      width: 70px;
      height: 70px;
      position: relative;
    }

    .progress-ring {
      width: 70px;
      height: 70px;
      transform: rotate(-90deg);
    }

    .progress-ring circle {
      width: 100%;
      height: 100%;
      fill: none;
      stroke-width: 5;
      stroke-linecap: round;
      r: 30px;
      cx: 35px;
      cy: 35px;
      stroke: #1f2937;
    }

    .progress-ring circle.progress-fill {
      stroke-dasharray: 188;
      stroke-dashoffset: 188;
      stroke: url(#grad);
      transition: stroke-dashoffset 0.3s ease;
    }

    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 16px;
      font-weight: 700;
      color: var(--primary);
    }

    .gen-results-section {
      display: grid;
      gap: 20px;
      margin-top: 20px;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    @media (max-width: 768px) {
      .gen-results-section { grid-template-columns: 1fr; gap: 16px; }
    }

    .gen-result-item {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .gen-result-preview {
      position: relative;
      height: 0;
      padding-bottom: 56.25%;
    }

    .gen-result-preview[data-ratio="9:16"] { padding-bottom: 177.78%; }
    .gen-result-preview[data-ratio="1:1"] { padding-bottom: 100%; }

    .gen-result-box {
      position: absolute;
      inset: 0;
      background: #020617;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .gen-result-placeholder {
      text-align: center;
      color: var(--text-muted);
    }

    .gen-result-placeholder i {
      display: block;
      font-size: 24px;
      margin-bottom: 8px;
      color: #4b5563;
    }

    .gen-canvas-container {
      position: absolute;
      inset: 16px;
      border-radius: 12px;
      overflow: hidden;
      display: none;
    }

    .gen-canvas-container canvas {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .gen-result-badge {
      position: absolute;
      bottom: 12px;
      right: 12px;
      z-index: 15;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      padding: 4px 8px;
      display: none;
      align-items: center;
      gap: 4px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      backdrop-filter: blur(6px);
      font-size: 10px;
      font-weight: 600;
    }

    .nsfw-blur { filter: blur(12px); }
    .nsfw-overlay {
      position: absolute;
      inset: 0;
      background: rgba(2, 6, 23, 0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 20;
      backdrop-filter: blur(5px);
    }

    .nsfw-overlay i { font-size: 48px; color: var(--accent-red); margin-bottom: 12px; }
    .nsfw-overlay h3 { color: var(--text-main); font-size: 16px; font-weight: 700; margin-bottom: 8px; }
    .nsfw-overlay p { color: var(--text-muted); font-size: 13px; text-align: center; }

    .nsfw-modal {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.98);
      backdrop-filter: blur(20px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .nsfw-modal-content {
      background: linear-gradient(135deg, #020617, #0f172a);
      border-radius: var(--radius-lg);
      padding: 40px;
      text-align: center;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-card);
      max-width: 400px;
      width: 90%;
    }

    .nsfw-modal h2 {
      color: var(--accent-red);
      margin-bottom: 20px;
      font-size: 24px;
    }

    .nsfw-modal-buttons {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .btn-age {
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 120px;
    }

    .btn-yes { background: linear-gradient(90deg, #4ade80, #22c55e); color: #020617; }
    .btn-no { background: transparent; color: var(--text-main); border: 2px solid var(--border-strong); }

    .selector-active, .ratio-active {
      background: linear-gradient(90deg, #4ade80, #22c55e) !important;
      box-shadow: 0 12px 30px rgba(34, 197, 94, 0.45) !important;
    }

    .footer {
      margin-top: 30px;
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
    }

    @media (max-width: 600px) {
      .actions { flex-direction: column; }
      .btn { width: 100%; }
      .tools-layout { gap: 16px; }
    }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="nav-inner">
      <div class="brand">
        <div class="brand-title">
          <div class="brand-icon"><i class="fas fa-bolt"></i></div>
          <span>BTF</span><span>Image AI</span>
        </div>
        <span class="brand-sub">1.6V • Perfect Mobile • Always Download</span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="tabs">
      <button class="tab active" id="tabTools">
        <i class="fas fa-sliders-h"></i><span>Image Tools</span>
      </button>
      <button class="tab" id="tabGenerator">
        <i class="fas fa-wand-sparkles"></i><span>AI Generator</span>
      </button>
    </div>

    <!-- TOOLS SECTION -->
    <section id="slideTools" class="tools-layout">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title"><i class="fas fa-image"></i>Upload Image</h2>
          <span class="card-sub">Drag or tap to upload</span>
        </div>
        <div class="image-container">
          <div class="image-drop" id="uploadArea">
            <div class="image-drop-inner" id="uploadPlaceholder">
              <i class="fas fa-cloud-upload-alt"></i>
              <h3>Drop your image</h3>
              <p>JPG, PNG • Max 10MB</p>
            </div>
            <div class="preview-wrapper" id="previewWrapper">
              <img id="previewImg" class="preview-img" alt="Preview" />
            </div>
            <input type="file" id="imageInput" accept="image/*" style="display:none" />
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-enhance" id="enhanceBtn" disabled>
            <i class="fas fa-wand-magic-sparkles"></i>Enhance
          </button>
          <button class="btn btn-bg" id="removeBgBtn" disabled>
            <i class="fas fa-scissors"></i>Remove BG
          </button>
        </div>
        <div class="status-bar" id="statusBar"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2 class="card-title"><i class="fas fa-panorama"></i>Result</h2>
          <span class="card-sub" id="resultLabel">Process image to see result</span>
        </div>
        <div class="image-container">
          <div class="image-drop">
            <div class="image-drop-inner result-placeholder" id="resultPlaceholder">
              <i class="fas fa-photo-video"></i>
              <h3>Result appears here</h3>
            </div>
            <img id="resultImg" class="result-img" style="display:none;" alt="Result" />
            <div class="result-badge" id="resultBadge" style="display:none;">
              <i class="fas fa-bolt"></i><span>BTF AI</span>
            </div>
          </div>
        </div>
        <div class="gen-item-download">
          <button class="btn-download" id="downloadBtn" style="display:none;">
            <i class="fas fa-download"></i>Download Result
          </button>
        </div>
      </div>
    </section>

    <!-- GENERATOR SECTION -->
    <section id="slideGenerator" style="display:none;">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title"><i class="fas fa-wand-sparkles"></i>AI Generator</h2>
          <span class="card-sub">Perfect ratios + NSFW allow + Always download</span>
        </div>

        <div class="gen-controls-top">
          <div class="gen-prompt-section">
            <div class="gen-prompt-label">
              <i class="fas fa-pen-nib"></i>Image Prompt
            </div>
            <textarea id="genPrompt" class="gen-prompt-input" 
              placeholder="Describe your image in detail. Example: cinematic portrait of a cyberpunk girl with neon pink hair, standing in rainy Tokyo street at midnight, ultra realistic, 8k"></textarea>
          </div>

          <div class="selector-section">
            <button class="btn btn-ratio ratio-active" data-ratio="16:9" id="ratio169">
              <i class="fas fa-expand-arrows-alt"></i>16:9
            </button>
            <button class="btn btn-ratio" data-ratio="9:16" id="ratio916">
              <i class="fas fa-mobile-alt"></i>9:16
            </button>
            <button class="btn btn-ratio" data-ratio="1:1" id="ratio11">
              <i class="fas fa-square"></i>1:1
            </button>
          </div>

          <div class="selector-section">
            <button class="btn btn-selector selector-active" data-images="1" id="select1">
              <i class="fas fa-image"></i>1 Image
            </button>
            <button class="btn btn-selector" data-images="2" id="select2">
              <i class="fas fa-images"></i>2 Images
            </button>
            <button class="btn btn-selector" data-images="4" id="select4">
              <i class="fas fa-clone"></i>4 Images
            </button>
          </div>
        </div>

        <div class="gen-generate-section">
          <button class="btn btn-generate" id="genBtn">
            <i class="fas fa-magic"></i><span>Generate 1 Image</span>
          </button>
          <div class="progress-circle" id="genProgressCircle">
            <svg class="progress-ring" viewBox="0 0 70 70">
              <defs>
                <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stop-color="#38bdf8"></stop>
                  <stop offset="100%" stop-color="#a855f7"></stop>
                </linearGradient>
              </defs>
              <circle cx="35" cy="35" r="30"></circle>
              <circle class="progress-fill" cx="35" cy="35" r="30"></circle>
            </svg>
            <div class="progress-text" id="progressText">0%</div>
          </div>
        </div>

        <div class="gen-results-section" id="genResultsSection" style="display:none;"></div>
        <div class="status-bar" id="genStatusBar"></div>
      </div>
    </section>

    <!-- NSFW MODAL -->
    <div class="nsfw-modal" id="nsfwModal">
      <div class="nsfw-modal-content">
        <h2><i class="fas fa-exclamation-triangle"></i> Age Verification</h2>
        <p>This content appears to contain mature/adult themes. Are you 18+?</p>
        <div class="nsfw-modal-buttons">
          <button class="btn-age btn-yes" id="ageYes">Yes, I'm 18+</button>
          <button class="btn-age btn-no" id="ageNo">No, under 18</button>
        </div>
      </div>
    </div>

    <p class="footer">© 2025 BTF Image AI 1.6V • Perfect Mobile • All Features Fixed</p>
  </main>

  <script>
    const API_BASE = "https://arimagex.netlify.app";
    const GENERATE_API = "https://flux.ashlynn.workers.dev";
    const LOGO_URL = "https://i.postimg.cc/GtcLf8X9/20251222-084642.png";

    // State
    let selectedRatio = "16:9";
    let selectedImages = 1;
    let isAdultVerified = localStorage.getItem('btfAdultVerified') === 'true';
    let currentNsfwImageIndex = null;
    let logoImage = null;

    // Elements
    const tabTools = document.getElementById("tabTools");
    const tabGenerator = document.getElementById("tabGenerator");
    const slideTools = document.getElementById("slideTools");
    const slideGenerator = document.getElementById("slideGenerator");
    
    // Tools
    const uploadArea = document.getElementById("uploadArea");
    const imageInput = document.getElementById("imageInput");
    const previewImg = document.getElementById("previewImg");
    const previewWrapper = document.getElementById("previewWrapper");
    const uploadPlaceholder = document.getElementById("uploadPlaceholder");
    const enhanceBtn = document.getElementById("enhanceBtn");
    const removeBgBtn = document.getElementById("removeBgBtn");
    const statusBar = document.getElementById("statusBar");
    const resultImg = document.getElementById("resultImg");
    const resultPlaceholder = document.getElementById("resultPlaceholder");
    const resultLabel = document.getElementById("resultLabel");
    const resultBadge = document.getElementById("resultBadge");
    const downloadBtn = document.getElementById("downloadBtn");

    // Generator
    const genPrompt = document.getElementById("genPrompt");
    const genBtn = document.getElementById("genBtn");
    const genStatusBar = document.getElementById("genStatusBar");
    const genProgressCircle = document.getElementById("genProgressCircle");
    const progressText = document.getElementById("progressText");
    const progressRingFill = document.querySelector(".progress-fill");
    const genResultsSection = document.getElementById("genResultsSection");
    const nsfwModal = document.getElementById("nsfwModal");

    // Selectors
    const ratioBtns = document.querySelectorAll('.btn-ratio');
    const selectBtns = document.querySelectorAll('.btn-selector');

    // Load logo
    const logoImg = new Image();
    logoImg.crossOrigin = "anonymous";
    logoImg.src = LOGO_URL;
    logoImg.onload = () => { logoImage = logoImg; };

    // Tab switching
    tabTools.addEventListener("click", () => {
      tabTools.classList.add("active");
      tabGenerator.classList.remove("active");
      slideTools.style.display = "block";
      slideGenerator.style.display = "none";
    });

    tabGenerator.addEventListener("click", () => {
      tabGenerator.classList.add("active");
      tabTools.classList.remove("active");
      slideGenerator.style.display = "block";
      slideTools.style.display = "none";
    });

    // Ratio selector
    ratioBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        ratioBtns.forEach(b => b.classList.remove('ratio-active'));
        btn.classList.add('ratio-active');
        selectedRatio = btn.dataset.ratio;
      });
    });

    // Image count selector
    selectBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        selectBtns.forEach(b => b.classList.remove('selector-active'));
        btn.classList.add('selector-active');
        selectedImages = parseInt(btn.dataset.images);
        genBtn.innerHTML = `<i class="fas fa-magic"></i><span>Generate ${selectedImages} Image${selectedImages > 1 ? 's' : ''}</span>`;
      });
    });

    // NSFW Modal
    document.getElementById("ageYes").addEventListener("click", () => {
      isAdultVerified = true;
      localStorage.setItem('btfAdultVerified', 'true');
      nsfwModal.style.display = "none";
      if (currentNsfwImageIndex !== null) showImage(currentNsfwImageIndex);
    });

    document.getElementById("ageNo").addEventListener("click", () => {
      nsfwModal.style.display = "none";
    });

    // NSFW detector
    function isNSFW(prompt) {
      const nsfwKeywords = [
        'nude','naked','porn','sex','xxx','adult','nsfw','hentai','boobs','breasts',
        'nipple','pussy','cock','dick','penis','vagina','asshole','strip','lingerie',
        'bikini','thong','topless','bottomless','erection','orgasm','masturbate'
      ];
      return nsfwKeywords.some(keyword => prompt.toLowerCase().includes(keyword));
    }

    // Generator functions
    async function addLogoToImage(imgSrc, canvas) {
      return new Promise((resolve) => {
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          if (logoImage) {
            const logoSize = Math.min(img.width * 0.12, 120);
            const logoX = img.width - logoSize - 20;
            const logoY = img.height - logoSize - 20;
            ctx.globalAlpha = 0.9;
            ctx.drawImage(logoImage, logoX, logoY, logoSize, logoSize);
            ctx.globalAlpha = 1;
          }
          resolve(true);
        };
        img.onerror = () => resolve(false);
        img.src = imgSrc;
      });
    }

    function updateProgress(percent) {
      const circumference = 188;
      const offset = circumference - (percent / 100) * circumference;
      progressRingFill.style.strokeDashoffset = offset;
      progressText.textContent = `${Math.round(percent)}%`;
    }

    function showProgress(show = true) {
      genProgressCircle.style.display = show ? "block" : "none";
      if (!show) updateProgress(0);
    }

    function genShowLoading(msg) {
      genStatusBar.classList.remove("status-error");
      genStatusBar.innerHTML = `<span>${msg}</span>`;
    }

    function genShowError(msg) {
      genStatusBar.classList.add("status-error");
      genStatusBar.innerHTML = `<i class="fas fa-circle-exclamation"></i> <span>${msg}</span>`;
    }

    function clearResults() {
      genResultsSection.innerHTML = '';
      genResultsSection.style.display = 'none';
      showProgress(false);
    }

    function createResultItem(index) {
      return `
        <div class="gen-result-item">
          <div class="gen-result-preview" data-ratio="${selectedRatio}">
            <div class="gen-result-box">
              <div class="gen-result-placeholder" id="genPlaceholder${index}">
                <i class="fas fa-photo-film"></i>
                <h4>Result ${index}</h4>
              </div>
              <div class="gen-canvas-container" id="genCanvasContainer${index}">
                <canvas id="genCanvas${index}"></canvas>
              </div>
              <div class="gen-result-badge" id="genResultBadge${index}">
                <i class="fas fa-bolt"></i><span>BTF AI</span>
              </div>
              <div class="nsfw-overlay" id="nsfwOverlay${index}">
                <i class="fas fa-ban"></i>
                <h3>NSFW Content</h3>
                <p>Adult content detected. Verify age to view.</p>
              </div>
            </div>
          </div>
          <div class="gen-item-download">
            <button class="btn-download" id="genDownloadBtn${index}">
              <i class="fas fa-download"></i>Download Result ${index}
            </button>
          </div>
        </div>
      `;
    }

    function showImage(index, isNsfw = false) {
      const container = document.getElementById(`genCanvasContainer${index}`);
      const placeholder = document.getElementById(`genPlaceholder${index}`);
      const badge = document.getElementById(`genResultBadge${index}`);
      const overlay = document.getElementById(`nsfwOverlay${index}`);
      const downloadBtn = document.getElementById(`genDownloadBtn${index}`);
      
      placeholder.style.display = "none";
      container.style.display = "block";
      badge.style.display = "flex";
      
      if (isNsfw && !isAdultVerified) {
        container.classList.add('nsfw-blur');
        overlay.style.display = "flex";
        downloadBtn.style.opacity = "0.5";
        downloadBtn.disabled = true;
      } else {
        container.classList.remove('nsfw-blur');
        overlay.style.display = "none";
        downloadBtn.style.opacity = "1";
        downloadBtn.disabled = false;
      }
    }

    async function generateSingleImage(prompt, ratio, index) {
      const uniqueSeed = Date.now() + index * 1000;
      const apiUrl = `${GENERATE_API}/?prompt=${encodeURIComponent(prompt)}&ratio=${encodeURIComponent(ratio)}&seed=${uniqueSeed}`;
      
      try {
        const res = await fetch(apiUrl, { 
          method: 'GET',
          headers: { 'Accept': 'application/json' }
        });
        
        if (!res.ok) throw new Error(`API Error: ${res.status}`);
        
        const data = await res.json();
        if (!data.success || !data.url) throw new Error("No image received");
        
        const canvas = document.getElementById(`genCanvas${index}`);
        await addLogoToImage(data.url, canvas);
        
        const isNsfwContent = isNSFW(prompt);
        if (isNsfwContent && !isAdultVerified) {
          currentNsfwImageIndex = index;
          nsfwModal.style.display = "flex";
        }
        
        showImage(index, isNsfwContent);
        return true;
      } catch (error) {
        throw error;
      }
    }

    async function generateImages() {
      const prompt = genPrompt.value.trim();
      if (!prompt) {
        genShowError("Please enter a prompt.");
        return;
      }

      clearResults();
      genShowLoading(`Generating ${selectedImages} image${selectedImages > 1 ? 's' : ''}...`);
      genBtn.disabled = true;
      showProgress(true);

      let resultsHTML = '';
      for (let i = 1; i <= selectedImages; i++) {
        resultsHTML += createResultItem(i);
      }
      genResultsSection.innerHTML = resultsHTML;
      genResultsSection.style.display = 'grid';

      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 85) progress = 85;
        updateProgress(progress);
      }, 800);

      try {
        const promises = [];
        for (let i = 1; i <= selectedImages; i++) {
          promises.push(generateSingleImage(prompt, selectedRatio, i));
        }

        await Promise.all(promises);

        clearInterval(progressInterval);
        updateProgress(100);
        setTimeout(() => {
          showProgress(false);
          genStatusBar.innerHTML = `<i class="fas fa-check-circle" style="color: #4ade80;"></i> <span>${selectedImages} image${selectedImages > 1 ? 's' : ''} ready!</span>`;
        }, 1000);

        // Download listeners
        for (let i = 1; i <= selectedImages; i++) {
          const downloadBtn = document.getElementById(`genDownloadBtn${i}`);
          downloadBtn.addEventListener('click', () => {
            const canvas = document.getElementById(`genCanvas${i}`);
            if (canvas && !downloadBtn.disabled) {
              const link = document.createElement('a');
              link.download = `btf-ai-result-${i}.png`;
              link.href = canvas.toDataURL('image/png');
              link.click();
            }
          });
        }

      } catch (error) {
        clearInterval(progressInterval);
        showProgress(false);
        genShowError(`Generation failed: ${error.message}`);
      } finally {
        genBtn.disabled = false;
      }
    }

    genBtn.addEventListener("click", generateImages);

    // TOOLS SECTION
    uploadArea.addEventListener("click", () => imageInput.click());
    ["dragover", "dragenter"].forEach(evt => {
      uploadArea.addEventListener(evt, e => e.preventDefault());
    });
    
    uploadArea.addEventListener("drop", e => {
      e.preventDefault();
      if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
    });
    
    imageInput.addEventListener("change", e => {
      if (e.target.files[0]) handleFile(e.target.files[0]);
    });

    function handleFile(file) {
      if (!file.type.startsWith("image/")) {
        showError("Please upload a valid image file.");
        return;
      }
      const reader = new FileReader();
      reader.onload = ev => {
        previewImg.src = ev.target.result;
        previewWrapper.style.display = "block";
        uploadPlaceholder.style.display = "none";
        enhanceBtn.disabled = false;
        removeBgBtn.disabled = false;
        clearResult();
      };
      reader.readAsDataURL(file);
    }

    function showLoading(msg) {
      statusBar.classList.remove("status-error");
      statusBar.innerHTML = `<div class="spinner"></div><span>${msg}</span>`;
    }

    function showError(msg) {
      statusBar.classList.add("status-error");
      statusBar.innerHTML = `<i class="fas fa-circle-exclamation"></i> <span>${msg}</span>`;
    }

    function clearStatus() {
      statusBar.classList.remove("status-error");
      statusBar.innerHTML = "";
    }

    function clearResult() {
      resultImg.style.display = "none";
      resultPlaceholder.style.display = "flex";
      downloadBtn.style.display = "none";
      resultLabel.textContent = "Process image to see result";
      resultBadge.style.display = "none";
    }

    async function processImage(action) {
      const currentBase64 = previewImg.src;
      if (!currentBase64) {
        showError("Please upload an image first.");
        return;
      }

      clearResult();
      enhanceBtn.disabled = true;
      removeBgBtn.disabled = true;
      showLoading(action === "enhance" ? "Enhancing image..." : "Removing background...");

      const endpoint = action === "enhance" ? `${API_BASE}/api/enhance` : `${API_BASE}/api/removebg`;

      try {
        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ imageUrl: currentBase64 })
        });

        if (!res.ok) throw new Error(`Server error: ${res.status}`);

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        resultImg.onload = () => {
          resultPlaceholder.style.display = "none";
          resultImg.style.display = "block";
          downloadBtn.style.display = "block";
          resultLabel.textContent = action === "enhance" ? "Enhanced Image" : "Background Removed";
          resultBadge.style.display = "flex";
          clearStatus();
        };
        resultImg.src = url;

      } catch (err) {
        showError("Processing failed. Please try again.");
      } finally {
        enhanceBtn.disabled = false;
        removeBgBtn.disabled = false;
      }
    }

    enhanceBtn.addEventListener("click", () => processImage("enhance"));
    removeBgBtn.addEventListener("click", () => processImage("removebg"));

    downloadBtn.addEventListener("click", () => {
      if (resultImg.src && resultImg.src !== window.location.href) {
        const a = document.createElement("a");
        a.href = resultImg.src;
        a.download = "btf-image-result.png";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    });
  </script>
</body>
</html>
